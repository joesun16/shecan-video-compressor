name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install PyQt6 pyinstaller
    
    - name: Download FFmpeg
      run: |
        Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
        New-Item -ItemType Directory -Force -Path "ffmpeg"
        Get-ChildItem -Path "ffmpeg_temp" -Directory | ForEach-Object { Copy-Item -Path "$($_.FullName)\bin\*" -Destination "ffmpeg" -Recurse }
        Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"
    
    - name: Build with PyInstaller
      run: pyinstaller --name="SheCan视频压缩工具" --windowed --onedir --noconfirm --icon=icon.ico --add-data "ffmpeg;ffmpeg" video_compressor.py
    
    - name: Build Installer
      uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
      with:
        path: installer.iss
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: Windows-Installer
        path: installer_output/*.exe

  build-macos:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install PyQt6 py2app
    
    - name: Download FFmpeg
      run: |
        mkdir -p ffmpeg
        curl -L "https://evermeet.cx/ffmpeg/getrelease/zip" -o ffmpeg.zip
        unzip ffmpeg.zip -d ffmpeg/
        curl -L "https://evermeet.cx/ffmpeg/getrelease/ffprobe/zip" -o ffprobe.zip
        unzip ffprobe.zip -d ffmpeg/
        chmod +x ffmpeg/ffmpeg ffmpeg/ffprobe
        rm -f ffmpeg.zip ffprobe.zip
    
    - name: Build with py2app
      run: |
        python setup.py py2app
        cp -r ffmpeg "dist/SheCan视频压缩工具.app/Contents/Resources/"
    
    - name: Create DMG
      run: |
        mkdir -p dmg_contents
        cp -r "dist/SheCan视频压缩工具.app" dmg_contents/
        ln -s /Applications dmg_contents/Applications
        hdiutil create -volname "SheCan视频压缩工具" -srcfolder dmg_contents -ov -format UDZO "SheCan视频压缩工具_macOS.dmg"
    
    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macOS-DMG
        path: "*.dmg"

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
    - name: Download Windows Installer
      uses: actions/download-artifact@v4
      with:
        name: Windows-Installer
        path: ./release
    
    - name: Download macOS DMG
      uses: actions/download-artifact@v4
      with:
        name: macOS-DMG
        path: ./release
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./release/*
        generate_release_notes: true
